#!/bin/bash
# ==========================================================
# Script de InstalaÃ§Ã£o Automatizada - Frente de Caixa RPDV
# ==========================================================

# Verifica se o usuÃ¡rio Ã© root
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Por favor, execute este script como root."
  exit 1
fi

# DiretÃ³rios
TMP_DIR="/tmp/install_frente"
BASE_DIR="/home/install"
ORIG_DIR="$BASE_DIR/rpdv"
DEST_DIR="/home/rpdv"
TARGET_HOME="/home"
TARGET_HOME2="/home/frente"

# FunÃ§Ã£o: Verifica comunicaÃ§Ã£o com a internet
verificar_comunicacao() {
    echo "ğŸ” Verificando comunicaÃ§Ã£o com a internet..."
    if ping -q -c 1 8.8.8.8 &>/dev/null; then
        echo "âœ… ComunicaÃ§Ã£o com a internet: OK"
    else
        echo "âŒ Sem comunicaÃ§Ã£o com a internet. Verifique a conexÃ£o de rede."
        sleep 5
        exit 1
    fi
}

# 1ï¸âƒ£ Verifica conexÃ£o
verificar_comunicacao

# 2ï¸âƒ£ Atualiza pacotes
echo "ğŸ”„ Atualizando pacotes do sistema..."
apt-get update -y
apt-get upgrade -y
apt-get -f install -y
apt-get install -y git unzip wget

# 3ï¸âƒ£ Prepara diretÃ³rio temporÃ¡rio
echo "ğŸ“ Preparando diretÃ³rio temporÃ¡rio..."
rm -rf "$TMP_DIR"
mkdir -p "$TMP_DIR"
cd "$TMP_DIR" || exit 1

# 4ï¸âƒ£ Faz o download no formato original do link FTP
echo "â¬‡ï¸ Baixando install.zip do FTP (formato original)..."
wget -p -m ftp://ftp.rpinfo.com.br/suporte/jeferson/frentee/bx/ \
  --ftp-user=jeferson.miranda \
  --ftp-password=rp2019@@

# 5ï¸âƒ£ Localiza o arquivo install.zip baixado
ZIP_FILE=$(find "$TMP_DIR" -type f -name "install.zip" | head -n 1)
if [ ! -f "$ZIP_FILE" ]; then
    echo "âŒ Erro: arquivo install.zip nÃ£o encontrado apÃ³s o download."
    exit 1
fi
echo "âœ… Download concluÃ­do: $ZIP_FILE"

# 6ï¸âƒ£ Extrai o conteÃºdo para /home
echo "ğŸ“¦ Extraindo conteÃºdo de install.zip para /home..."
unzip -o "$ZIP_FILE" -d "$TARGET_HOME" > /dev/null 2>&1

if [ ! -d "$BASE_DIR" ]; then
    echo "âŒ Erro: diretÃ³rio /home/install nÃ£o encontrado apÃ³s extraÃ§Ã£o."
    exit 1
fi
echo "âœ… ExtraÃ§Ã£o concluÃ­da."

# 7ï¸âƒ£ Move /home/install/rpdv â†’ /home/rpdv
if [ -d "$ORIG_DIR" ]; then
    echo "ğŸ“‚ Movendo arquivos de $ORIG_DIR para $DEST_DIR..."
    mkdir -p "$DEST_DIR"
    mv "$ORIG_DIR"/* "$DEST_DIR"/ 2>/dev/null || echo "âš ï¸ Nenhum arquivo para mover de $ORIG_DIR."
    rm -rf "$ORIG_DIR"
else
    echo "âš ï¸ DiretÃ³rio $ORIG_DIR nÃ£o encontrado, ignorando etapa de cÃ³pia."
fi

# 8ï¸âƒ£ Move demais arquivos da instalaÃ§Ã£o
echo "ğŸ“‚ Movendo arquivos restantes de $BASE_DIR para $TARGET_HOME..."
shopt -s dotglob nullglob
mv "$BASE_DIR"/* "$TARGET_HOME"/ 2>/dev/null || echo "âš ï¸ Nenhum arquivo restante em $BASE_DIR."
shopt -u dotglob nullglob

# 9ï¸âƒ£ Ajusta permissÃµes em /home
echo "ğŸ” Ajustando permissÃµes em /home..."
chmod -R 777 "$TARGET_HOME"/*

# ğŸ”Ÿ Clona e executa o script do repositÃ³rio Git
echo "ğŸ“¥ Clonando repositÃ³rio do frente..."
rm -rf "$TARGET_HOME2"
git clone https://github.com/JefersonMiranda1064/frente/ "$TARGET_HOME2"

if [ -f "$TARGET_HOME2/insta64bit.sh" ]; then
    echo "ğŸš€ Executando script de prÃ©-instalaÃ§Ã£o do frente..."
    chmod +x "$TARGET_HOME2/insta64bit.sh"
    bash "$TARGET_HOME2/insta64bit.sh"
else
    echo "âŒ Erro: arquivo insta64bit.sh nÃ£o encontrado em $TARGET_HOME2."
    exit 1
fi

# ğŸ§¹ Limpeza final
echo "ğŸ§¹ Limpando diretÃ³rio temporÃ¡rio..."
rm -rf "$TMP_DIR"

echo "âœ… InstalaÃ§Ã£o concluÃ­da com sucesso!"
